---
title: "Headless 브라우저를 이용한 스냅샷 촬영 구현"
author:
  name: 박 찬영
  link: https://github.com/univdev
categories: [Tech, Talk]
---
## 들어가며
요즘 업무가 바빠 기술 블로그에 글을 투고 한지 너무 오래 되었다는 것도 잊고 있었습니다.  
1년 전 부터 준비하던 서비스가 런칭을 목전에 두고 있기에 굉장히 설레는 요즘을 보내고 있거든요!
## 요즘 개발하는 서비스란?
![숨겨진 서비스](/assets/img/posts/2023-08-02-19-49-33.png)  
짜잔! 이처럼 정말 예쁘고 강력한 디자인 서비스를 개발하고 있었습니다.  
이 서비스에서 가장 강력한 기능이자, 제가 가장 많은 공을 들린 기능은 바로 디자인 편집 툴입니다.  
디자인 편집을 가능하게 해주는 이 에디터는 브라우저의 DOM을 이용하는데요, 에디터를 어떻게 만들었는지에 대해서는 할 얘기가 정말 너무 많지만 오늘은 이 얘기에 대해서 조금 접어두고 다른 얘기를 하고자 해요.

## DOM 렌더링 엔진의 한계
위에서 말씀 드렸다시피 이 에디터는 DOM으로 설계 되어 동작하고 있어요.  

![디자인 썸네일](/assets/img/posts/2023-08-02-19-48-26.png)  
그렇다보니 이와 같이 사용자가 작업한 디자인을 미리 보여주는 스냅샷을 촬영하는게 하나의 난제로 다가오게 되었어요.  
왜냐면 일반적인 방법으로는 DOM에 그려진 요소들을 레스터 이미지로 만드는 방법이 존재하지 않았고, [html2canvas](https://html2canvas.hertzen.com/)와 같은 라이브러리는 렌더링 된 화면을 온전히 그려내지 못했거든요.
이런 기능은 비단 Snapshot 뿐 아니라 유저가 제작한 디자인을 다운로드 받게 하는 **핵심 기능에도 관여하기 때문에 반드시 해결해야만 하는 문제였어요.**

그러다가 생각해 낸 하나의 묘수가 바로 Headless 브라우저를 이용한 스냅샷 촬영이었어요.  
촬영 플로우는 다음과 같아요.
1. Headless 브라우저를 이용하여 렌더링 엔진을 활성화 한다.
2. 렌더링 엔진에서 사용자가 편집한 디자인을 그려낸다.
3. 렌더링 엔진 자체를 Headless 브라우저의 `screenshot` 메소드를 사용하여 촬영한다.
4. base64로 반환한다.

자, 정말 완벽한 계획이죠?

다만 이 플랜에는 한가지 단점이 있었어요.  
**렌더링 엔진을 호스팅하는 서비스에 접근하여 그려내야 한다**는 점이에요.

일단 브라우저를 켜고, 렌더링 엔진 호스팅 서비스에 접근하는 행위 자체가 다소 시간이 걸린다는 점이 문제였어요.  
이 과정에서 병목을 최대한 줄이기 위해 가장 유명한 브라우저인 Puppeteer 대신 Playwright 브라우저를 채택하자고 아이디어를 낸 백엔드 개발팀 덕분에 브라우저 인스턴스에 대한 로딩 속도는 어느정도 해결 했지만 네트워크 접속 시간에 대해서는 어떻게 하기가 어렵더라구요.  
그래서 제가 생각해낸 아이디어는 '**한번 호출한 리소스는 최대한 빼먹어보자**'였어요.

기존 스냅샷 촬영 플로우는 다음과 같아요.
